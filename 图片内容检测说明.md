# 图片内容智能检测功能说明

## 📋 功能概述

使用**硅基流动 Qwen3-VL-32B-Instruct** 视觉模型，智能检测学术论文中图表的内容规范性。

## 🎯 检测规则

### 1. 刻度线方向
- ✅ 刻度线应指向图内部
- ❌ 刻度线指向图外部

### 2. 物理量和单位表示
- **格式**: `物理量/单位` （用`/`分隔）
- **物理量符号**: 必须为**斜体**（如 *E*, *H*）
- **单位符号**: 必须为**正体**（如 m, kg）
- 示例：
  - ✅ *E*/(V/m) - 物理量E斜体，单位正体
  - ❌ E/(V/m) - 物理量E没有斜体
  - ❌ *E*/*V/m* - 单位V和m不应该斜体

### 3. 组合单位括号规则
- **组合单位**: 必须加括号
  - ✅ (H/m), (kg/m³), (J/(mol·K))
  - ❌ H/m, kg/m³
- **特殊情况**:
  - ✅ ℃ - 摄氏度不加括号
  - ✅ (°) - 角度单位必须加括号

### 4. 数值格式统一性
- 小数保留位数必须统一
- **规则**: 如果纵轴使用一位小数（0.1, 0.2），横轴也必须使用一位小数
  - ✅ 纵轴: 0.1, 0.2, 0.3 → 横轴: 1.0, 2.0, 3.0
  - ❌ 纵轴: 0.1, 0.2, 0.3 → 横轴: 1, 2, 3

### 5. 坐标轴标题一致性
- 纵坐标和横坐标的标题表示方式必须统一
- **统一使用文字** 或 **统一使用符号**，不能混用
  - ✅ 纵坐标: Temperature, 横坐标: Time（都用文字）
  - ✅ 纵坐标: *T*, 横坐标: *t*（都用符号）
  - ❌ 纵坐标: Temperature, 横坐标: *t*（混用）

## 🚀 使用方法

### 方法1: 单独测试图片内容检测

```bash
python test_figure_content.py template/test.docx 20 your_api_key
```

参数说明：
- `template/test.docx` - Word文档路径
- `20` - 包含图片的段落索引
- `your_api_key` - 硅基流动API密钥

### 方法2: 集成到完整检测流程

1. **配置API密钥**

创建 `config_api.py` 文件（从 `config_api.example.py` 复制）：

```python
# config_api.py
SILICONFLOW_API_KEY = "sk-your-actual-api-key"
ENABLE_FIGURE_CONTENT_CHECK = True
```

2. **运行检测**

```python
from paper_detect.Figure_detect import check_doc_with_template

# 启用内容检测
result = check_doc_with_template(
    doc_path='template/test.docx',
    template_identifier='Figure',
    enable_content_check=True,
    api_key='your_api_key'
)
```

### 方法3: 在代码中直接使用

```python
from paper_detect.Figure_content_detect import FigureContentDetector
from docx import Document

# 初始化检测器
api_key = "your_siliconflow_api_key"
detector = FigureContentDetector(api_key)

# 加载文档
doc = Document('paper.docx')

# 假设第20段包含图片
paragraph = doc.paragraphs[20]

# 执行检测
result = detector.detect_figure_content(paragraph, 'paper.docx')

# 查看结果
if result['is_chart']:
    if result['ok']:
        print("✅ 图表符合规范")
    else:
        print("❌ 发现问题:")
        for msg in result['messages']:
            print(f"  - {msg}")
else:
    print("ℹ️ 非图表类型")
```

## 📊 API说明

### 硅基流动API

- **模型**: Qwen3-VL-32B-Instruct
- **API端点**: https://api.siliconflow.cn/v1/chat/completions
- **获取API密钥**: https://siliconflow.cn

### API配置

```python
class FigureContentDetector:
    def __init__(self, 
                 api_key: str, 
                 api_base: str = "https://api.siliconflow.cn/v1"):
        """
        api_key: API密钥
        api_base: API基础URL（可选）
        """
```

## 📝 检测结果格式

```json
{
  "ok": true/false,
  "is_chart": true/false,
  "messages": [
    "问题描述1",
    "问题描述2"
  ],
  "details": {
    "is_chart": true,
    "issues": [
      {
        "rule": "刻度线方向",
        "severity": "error",
        "description": "刻度线指向图外部，应指向图内"
      }
    ],
    "summary": "总体评价"
  }
}
```

## 🔧 依赖安装

```bash
pip install requests pillow python-docx
```

## ⚠️ 注意事项

1. **API密钥安全**: 不要将API密钥提交到版本控制系统
2. **API费用**: 视觉模型API调用会产生费用，请注意使用量
3. **响应时间**: 视觉模型分析需要时间（通常10-30秒）
4. **图片质量**: 图片质量越高，检测准确度越高
5. **网络连接**: 需要稳定的网络连接访问API

## 🎓 示例

假设有一张图表，检测结果可能如下：

```
✓ 检测到图表

❌ 发现以下问题：
  ❌ [物理量单位表示] 纵坐标"E/(V/m)"中的物理量E未使用斜体
  ❌ [数值格式] 纵轴使用一位小数(0.1, 0.2)，但横轴使用整数(1, 2)，应统一为(1.0, 2.0)
  ⚠️  [组合单位] 单位"V/m"应加括号写为"(V/m)"
```

## 📚 相关文件

- `paper_detect/Figure_content_detect.py` - 内容检测核心模块
- `paper_detect/Figure_detect.py` - 图片格式检测主模块
- `test_figure_content.py` - 测试脚本
- `config_api.example.py` - API配置示例
- `图片内容检测说明.md` - 本文档

## 🤝 技术支持

如遇问题，请检查：
1. API密钥是否正确
2. 网络连接是否正常
3. 文档中是否包含图片
4. 图片是否为图表类型（非照片、示意图）

