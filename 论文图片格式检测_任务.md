# Context
Filename: 论文图片格式检测_任务.md
Created On: 2025-10-28
Created By: User & AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
为论文格式检测系统添加图片（Figure）格式检测功能。

## 具体需求
1. **标题格式规范**：
   - 格式模式：`Fig.编号 标题文字`（如 `Fig.1 Material structure`）
   - `Fig.编号` 与标题文字之间有一个空格
   - 字体：Times New Roman
   - 字号：五号（10.5pt）
   - 对齐方式：居中
   
2. **编号规则**：
   - 图片编号从1开始
   - 编号必须连续递增（Fig.1, Fig.2, Fig.3...）

3. **位置关系**：
   - 标题位于图片下方
   - 图片本身居中对齐

# Project Overview
论文格式检测系统（paper_detect）是一个基于Python和python-docx的学术论文Word文档格式检测工具。

## 现有架构
- **检测模块目录**：`paper_detect/` - 包含6个检测模块
  - Title_detect.py - 标题检测
  - Abstract_detect.py - 摘要检测
  - Keywords_detect.py - 关键词检测
  - Content_detect.py - 正文检测
  - Formula_detect.py - 公式检测
  - Table_detect.py - 表格检测（三线表）

- **模板配置目录**：`templates/` - JSON格式的检测规则配置
- **集成脚本**：`run_all_detections.py` - 调用所有检测模块并生成报告和批注文档
- **API服务**：`api_service/` - FastAPI封装的RESTful API服务

## 技术栈
- Python 3.x
- python-docx（Word文档处理）
- FastAPI（API服务）
- JSON配置文件

## 参考模块
Table_detect.py 已实现类似功能：
- 标题格式检测（Table X 表名）
- 编号连续性检测
- 字体、字号、对齐方式检测
- 位置关系验证

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 关键发现

### 1. 代码中已识别图片标题
在 `Content_detect.py` 和 `run_all_detections.py` 中，系统已经识别并排除了图片标题：
- 检测到以 `figure `、`fig.`、`图 ` 开头的段落
- 使用正则表达式匹配 `^(表|图|Table|Figure)\s*\d+`

### 2. python-docx 图片处理能力
python-docx 库支持：
- 检测段落中的图片对象（`paragraph.runs[].element` 中的图片元素）
- 通过 `paragraph._element.xpath()` 查找图片节点
- 图片通常以 `<w:drawing>` 或 `<w:pict>` 元素存储在 XML 中
- 段落的对齐方式可以通过 `paragraph.alignment` 检测

### 3. 现有检测模式（参考 Table_detect.py）
表格检测的实现模式可直接借鉴：
- **标题定位**：遍历段落，使用正则匹配标题模式
- **格式检查**：字体、字号、加粗、对齐
- **编号检查**：提取编号，验证起始值和连续性
- **位置关系**：通过段落索引验证标题与内容对象的位置关系

### 4. 图片与标题的位置关系判断
在Word文档中，图片和标题的典型结构：
```
段落N: [包含图片对象的段落]
段落N+1: [图片标题段落] "Fig.1 Description"
```

需要验证：
- 标题段落的上一个段落包含图片对象
- 或者标题段落的上方紧邻的非空段落包含图片对象

### 5. 检测流程设计
1. 遍历文档段落，识别图片标题段落（匹配 `Fig.\d+`）
2. 提取标题信息（编号、标题文字）
3. 检查标题格式（字体、字号、对齐）
4. 验证编号连续性
5. 向上查找图片对象段落，验证位置关系和图片对齐

### 6. 需要创建的文件
- `paper_detect/Figure_detect.py` - 图片格式检测模块
- `templates/Figure.json` - 图片检测规则配置

### 7. 需要修改的文件
- `run_all_detections.py` - 添加 Figure 模块到检测流程
- `api_service/api.py` - （可选）如果需要在API中集成

### 8. 技术约束
- python-docx 对图片的访问主要通过 XML 解析
- 图片对象识别需要检查 `w:drawing` 或 `w:pict` 元素
- 段落可能包含多个 run，需要遍历所有 run 检查图片

## 依赖文件
- `templates/Table.json` - 参考结构
- `paper_detect/Table_detect.py` - 参考实现逻辑

# Proposed Solution (Populated by INNOVATE mode)
[待填充]

# Implementation Plan (Generated by PLAN mode)
[待填充]

# Current Execution Step (Updated by EXECUTE mode when starting a step)
[待填充]

# Task Progress (Appended by EXECUTE mode after each step completion)
[待填充]

# Final Review (Populated by REVIEW mode)
[待填充]

