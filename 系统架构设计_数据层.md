# 论文格式检测系统 - 数据层设计

## 📋 系统架构概览

```
┌─────────────────────────────────────────────────────────┐
│                     表示层 (UI)                          │
├─────────────────────────────────────────────────────────┤
│ 登录界面 │ 稿件管理 │ 格式检测 │ 报告生成 │ 模板上传 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     业务层 (Logic)                       │
├─────────────────────────────────────────────────────────┤
│ 用户认证 │ 稿件管理 │ 格式检测 │ 报告生成 │ 模板管理 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     数据层 (Data)                        │
├─────────────────────────────────────────────────────────┤
│  用户表  │  稿件表  │  检测表  │  报告表  │  模板表  │
└─────────────────────────────────────────────────────────┘
```

## 🗄️ 数据库表结构设计

### 1. 用户管理模块

#### 1.1 users - 用户表
```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    real_name VARCHAR(100),
    role ENUM('admin', 'editor', 'reviewer', 'author') DEFAULT 'author',
    status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    INDEX idx_username (username),
    INDEX idx_email (email)
);
```

**字段说明**：
- `user_id`: 用户唯一标识
- `username`: 登录用户名
- `password_hash`: 密码哈希（使用bcrypt）
- `role`: 角色（管理员/编辑/审稿人/作者）
- `status`: 账户状态

#### 1.2 sessions - 会话表
```sql
CREATE TABLE sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    user_id INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    INDEX idx_token (token),
    INDEX idx_user_id (user_id)
);
```

---

### 2. 稿件管理模块

#### 2.1 manuscripts - 稿件表
```sql
CREATE TABLE manuscripts (
    manuscript_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    title VARCHAR(500),
    author_names TEXT,
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_modified DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    status ENUM('uploaded', 'detecting', 'detected', 'approved', 'rejected') DEFAULT 'uploaded',
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT,
    file_hash VARCHAR(64),
    current_version INT DEFAULT 1,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_upload_time (upload_time)
);
```

**字段说明**：
- `manuscript_id`: 稿件唯一标识
- `user_id`: 上传用户
- `title`: 论文标题
- `author_names`: 作者姓名（从文档中提取）
- `status`: 稿件状态
- `file_hash`: 文件MD5，用于去重和版本对比

#### 2.2 manuscript_versions - 稿件版本表
```sql
CREATE TABLE manuscript_versions (
    version_id INT PRIMARY KEY AUTO_INCREMENT,
    manuscript_id INT NOT NULL,
    version_number INT NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_hash VARCHAR(64),
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    upload_by INT NOT NULL,
    change_description TEXT,
    FOREIGN KEY (manuscript_id) REFERENCES manuscripts(manuscript_id),
    FOREIGN KEY (upload_by) REFERENCES users(user_id),
    UNIQUE KEY uk_manuscript_version (manuscript_id, version_number),
    INDEX idx_manuscript_id (manuscript_id)
);
```

---

### 3. 格式检测模块

#### 3.1 detection_tasks - 检测任务表
```sql
CREATE TABLE detection_tasks (
    task_id VARCHAR(64) PRIMARY KEY,
    manuscript_id INT NOT NULL,
    version_id INT,
    detection_type VARCHAR(50),  -- 'full', 'figure_only', 'quick', etc.
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    started_at DATETIME,
    completed_at DATETIME,
    enable_figure_api BOOLEAN DEFAULT FALSE,
    error_message TEXT,
    FOREIGN KEY (manuscript_id) REFERENCES manuscripts(manuscript_id),
    FOREIGN KEY (version_id) REFERENCES manuscript_versions(version_id),
    INDEX idx_manuscript_id (manuscript_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

**字段说明**：
- `task_id`: 任务UUID
- `detection_type`: 检测类型（完整检测/仅图片/快速检测）
- `enable_figure_api`: 是否启用图片内容API检测

#### 3.2 detection_results - 检测结果表
```sql
CREATE TABLE detection_results (
    result_id INT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(64) NOT NULL,
    module_name VARCHAR(50) NOT NULL,  -- 'Title', 'Abstract', 'Figure', etc.
    overall_status ENUM('pass', 'fail', 'warning') DEFAULT 'pass',
    total_checks INT DEFAULT 0,
    passed_checks INT DEFAULT 0,
    failed_checks INT DEFAULT 0,
    result_json JSON,  -- 完整的检测结果JSON
    FOREIGN KEY (task_id) REFERENCES detection_tasks(task_id),
    INDEX idx_task_id (task_id),
    INDEX idx_module_name (module_name)
);
```

#### 3.3 detection_issues - 检测问题明细表
```sql
CREATE TABLE detection_issues (
    issue_id INT PRIMARY KEY AUTO_INCREMENT,
    result_id INT NOT NULL,
    issue_category VARCHAR(100),  -- 'format', 'alignment', 'numbering', etc.
    issue_type VARCHAR(100),
    severity ENUM('error', 'warning', 'info') DEFAULT 'error',
    description TEXT NOT NULL,
    location_method VARCHAR(50),  -- 'keyword', 'index', 'paragraph'
    location_data VARCHAR(500),
    paragraph_index INT,
    is_resolved BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (result_id) REFERENCES detection_results(result_id),
    INDEX idx_result_id (result_id),
    INDEX idx_severity (severity)
);
```

---

### 4. 图片处理模块

#### 4.1 extracted_figures - 提取的图片表
```sql
CREATE TABLE extracted_figures (
    figure_id INT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(64) NOT NULL,
    manuscript_id INT NOT NULL,
    figure_index INT NOT NULL,  -- 第几张图片
    figure_number INT,  -- Fig.编号（如果有标题）
    has_caption BOOLEAN DEFAULT FALSE,
    caption_text TEXT,
    image_path VARCHAR(500) NOT NULL,
    image_format VARCHAR(10),  -- 'jpg', 'png', etc.
    image_size BIGINT,
    paragraph_index INT,
    extracted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES detection_tasks(task_id),
    FOREIGN KEY (manuscript_id) REFERENCES manuscripts(manuscript_id),
    INDEX idx_task_id (task_id),
    INDEX idx_manuscript_id (manuscript_id)
);
```

#### 4.2 figure_content_checks - 图片内容检测表
```sql
CREATE TABLE figure_content_checks (
    check_id INT PRIMARY KEY AUTO_INCREMENT,
    figure_id INT NOT NULL,
    is_chart BOOLEAN DEFAULT FALSE,
    chart_type VARCHAR(50),
    overall_result ENUM('pass', 'fail', 'skip') DEFAULT 'skip',
    
    -- 各项检测结果
    tick_direction_ok BOOLEAN,
    tick_direction_desc TEXT,
    
    unit_format_ok BOOLEAN,
    unit_format_issues JSON,
    
    unit_brackets_ok BOOLEAN,
    unit_brackets_issues JSON,
    
    decimal_consistency_ok BOOLEAN,
    decimal_consistency_desc TEXT,
    
    axis_title_consistency_ok BOOLEAN,
    axis_title_desc TEXT,
    
    api_response_json JSON,  -- 完整API响应
    checked_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (figure_id) REFERENCES extracted_figures(figure_id),
    INDEX idx_figure_id (figure_id)
);
```

---

### 5. 报告管理模块

#### 5.1 detection_reports - 检测报告表
```sql
CREATE TABLE detection_reports (
    report_id INT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(64) NOT NULL UNIQUE,
    manuscript_id INT NOT NULL,
    
    -- 报告文件
    text_report_path VARCHAR(500),
    annotated_doc_path VARCHAR(500),
    json_report_path VARCHAR(500),
    
    -- 统计信息
    total_modules INT DEFAULT 0,
    passed_modules INT DEFAULT 0,
    total_issues INT DEFAULT 0,
    
    -- 汇总统计
    title_status ENUM('pass', 'fail', 'skip'),
    abstract_status ENUM('pass', 'fail', 'skip'),
    keywords_status ENUM('pass', 'fail', 'skip'),
    content_status ENUM('pass', 'fail', 'skip'),
    formula_status ENUM('pass', 'fail', 'skip'),
    figure_status ENUM('pass', 'fail', 'skip'),
    table_status ENUM('pass', 'fail', 'skip'),
    
    overall_pass_rate DECIMAL(5,2),
    
    generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (task_id) REFERENCES detection_tasks(task_id),
    FOREIGN KEY (manuscript_id) REFERENCES manuscripts(manuscript_id),
    INDEX idx_manuscript_id (manuscript_id),
    INDEX idx_generated_at (generated_at)
);
```

---

### 6. 模板管理模块

#### 6.1 detection_templates - 检测模板表
```sql
CREATE TABLE detection_templates (
    template_id INT PRIMARY KEY AUTO_INCREMENT,
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,  -- 'Title', 'Abstract', 'Figure', etc.
    config_json JSON NOT NULL,  -- JSON配置内容
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    version INT DEFAULT 1,
    description TEXT,
    FOREIGN KEY (created_by) REFERENCES users(user_id),
    INDEX idx_template_type (template_type),
    INDEX idx_is_default (is_default)
);
```

#### 6.2 template_history - 模板历史版本表
```sql
CREATE TABLE template_history (
    history_id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT NOT NULL,
    version_number INT NOT NULL,
    config_json JSON NOT NULL,
    modified_by INT,
    modified_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    change_description TEXT,
    FOREIGN KEY (template_id) REFERENCES detection_templates(template_id),
    FOREIGN KEY (modified_by) REFERENCES users(user_id),
    UNIQUE KEY uk_template_version (template_id, version_number)
);
```

---

### 7. API使用管理模块

#### 7.1 api_usage - API调用记录表
```sql
CREATE TABLE api_usage (
    usage_id INT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(64) NOT NULL,
    figure_id INT,
    api_type VARCHAR(50) DEFAULT 'siliconflow',
    model_name VARCHAR(100),
    check_type VARCHAR(50),  -- 'is_chart', 'tick_direction', etc.
    
    request_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    response_time DATETIME,
    duration_ms INT,  -- 响应时长（毫秒）
    
    status ENUM('success', 'failed', 'timeout') DEFAULT 'success',
    error_message TEXT,
    
    tokens_used INT,
    estimated_cost DECIMAL(10,4),
    
    FOREIGN KEY (task_id) REFERENCES detection_tasks(task_id),
    FOREIGN KEY (figure_id) REFERENCES extracted_figures(figure_id),
    INDEX idx_task_id (task_id),
    INDEX idx_request_time (request_time)
);
```

---

### 8. 系统配置模块

#### 8.1 system_config - 系统配置表
```sql
CREATE TABLE system_config (
    config_id INT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(50),  -- 'string', 'number', 'boolean', 'json'
    description TEXT,
    is_sensitive BOOLEAN DEFAULT FALSE,  -- 是否为敏感配置（如API密钥）
    updated_by INT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(user_id)
);
```

**预设配置项**：
```sql
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('api.siliconflow.key', '', 'string', '硅基流动API密钥'),
('api.siliconflow.model', 'Qwen/Qwen3-VL-32B-Instruct', 'string', '视觉模型名称'),
('figure.save_images', 'true', 'boolean', '是否保存提取的图片'),
('figure.enable_api_by_default', 'false', 'boolean', '默认是否启用API检测'),
('storage.upload_dir', 'uploads', 'string', '稿件上传目录'),
('storage.result_dir', 'results', 'string', '检测结果目录');
```

---

## 📊 数据表关系图

```
users (用户)
  ├─→ manuscripts (稿件)
  │     ├─→ manuscript_versions (稿件版本)
  │     ├─→ detection_tasks (检测任务)
  │     │     ├─→ detection_results (检测结果)
  │     │     │     └─→ detection_issues (问题明细)
  │     │     ├─→ detection_reports (检测报告)
  │     │     ├─→ extracted_figures (提取的图片)
  │     │     │     └─→ figure_content_checks (图片内容检测)
  │     │     └─→ api_usage (API使用记录)
  │     └─→ detection_reports (关联)
  │
  ├─→ detection_templates (模板)
  │     └─→ template_history (模板历史)
  │
  └─→ sessions (会话)
```

---

## 📋 核心数据实体总结

### 基础数据（8个核心表）
1. **users** - 用户信息
2. **manuscripts** - 稿件基本信息
3. **detection_tasks** - 检测任务
4. **detection_results** - 检测结果
5. **detection_reports** - 检测报告
6. **extracted_figures** - 提取的图片
7. **detection_templates** - 检测模板
8. **system_config** - 系统配置

### 扩展数据（5个辅助表）
9. **sessions** - 用户会话
10. **manuscript_versions** - 稿件版本
11. **detection_issues** - 问题明细
12. **figure_content_checks** - 图片内容检测详情
13. **api_usage** - API调用记录
14. **template_history** - 模板历史

---

## 🔄 典型业务流程的数据流

### 流程1：上传稿件并检测

```
1. 用户登录
   → INSERT INTO sessions

2. 上传稿件
   → INSERT INTO manuscripts
   → INSERT INTO manuscript_versions (v1)
   → 保存文件到 uploads/

3. 启动检测
   → INSERT INTO detection_tasks (status='pending')
   → 后台处理：status='processing'

4. 执行检测
   → 调用各检测模块
   → INSERT INTO detection_results (7条，对应7个模块)
   → INSERT INTO detection_issues (每个问题一条)
   → 如果有图片：
       → INSERT INTO extracted_figures
       → 保存图片到 extracted_figures/
       → 如果启用API：
           → INSERT INTO figure_content_checks
           → INSERT INTO api_usage (每次API调用)

5. 生成报告
   → 生成文本报告、批注文档
   → INSERT INTO detection_reports
   → 保存报告文件到 results/
   → UPDATE detection_tasks SET status='completed'

6. 用户查看报告
   → SELECT FROM detection_reports
   → 下载文本报告、批注文档
```

### 流程2：上传新版本稿件

```
1. 用户上传修改后的稿件
   → INSERT INTO manuscript_versions (v2)
   → UPDATE manuscripts SET current_version=2

2. 重新检测
   → INSERT INTO detection_tasks (version_id=v2)
   → 执行检测...
   → 对比v1和v2的检测结果
```

### 流程3：模板管理

```
1. 管理员上传新模板
   → INSERT INTO detection_templates
   
2. 修改模板
   → INSERT INTO template_history (保留历史)
   → UPDATE detection_templates
   
3. 切换默认模板
   → UPDATE detection_templates SET is_default=FALSE WHERE template_type='Figure'
   → UPDATE detection_templates SET is_default=TRUE WHERE template_id=X
```

---

## 💾 文件存储结构

```
project_root/
├── uploads/                    # 上传的稿件
│   ├── user_123/
│   │   ├── manuscript_456_v1.docx
│   │   └── manuscript_456_v2.docx
│   └── user_124/
│
├── results/                    # 检测结果
│   ├── task_abc123/
│   │   ├── report.txt
│   │   ├── annotated.docx
│   │   └── report.json
│   └── task_def456/
│
├── extracted_figures/          # 提取的图片
│   ├── task_abc123/
│   │   ├── manuscript_456_Fig1.jpg
│   │   └── manuscript_456_Fig2.png
│   └── task_def456/
│
├── api_results/                # API响应
│   ├── task_abc123_api_response.json
│   └── task_def456_api_response.json
│
└── templates/                  # 检测模板（JSON文件）
    ├── default/
    │   ├── Title.json
    │   ├── Figure.json
    │   └── ...
    └── custom/
        └── user_templates/
```

---

## 🎯 数据量估算

假设系统规模：
- **用户数**：100-1000
- **每月稿件**：1000篇
- **每篇检测**：2-3次（初检+修改后复检）
- **每篇图片**：平均5张

**年数据量**：
- manuscripts: ~12,000条
- detection_tasks: ~30,000条
- detection_results: ~210,000条（30k × 7模块）
- extracted_figures: ~150,000条（30k × 5图/篇）
- figure_content_checks: ~150,000条（如果启用API）

**存储需求**：
- 数据库：< 5GB/年
- 文件存储：~100GB/年（稿件+图片+报告）

---

## 🔐 安全考虑

### 敏感数据处理
1. **密码**：使用bcrypt哈希，不存明文
2. **API密钥**：加密存储在system_config，标记is_sensitive=TRUE
3. **文件隔离**：按用户ID分目录存储

### 权限控制
1. **用户只能查看自己的稿件**
2. **编辑/审稿人可查看分配的稿件**
3. **管理员可查看所有数据**
4. **模板修改仅限管理员**

---

## 🚀 扩展性设计

### 支持未来功能
1. **批量检测**：一次上传多个文件
2. **定时检测**：设置检测队列
3. **对比检测**：对比不同版本的检测结果
4. **统计分析**：用户/稿件/检测的统计图表
5. **导出功能**：批量导出报告（PDF/Excel）

### 性能优化
1. **索引优化**：已在关键字段添加索引
2. **分区表**：可按时间分区（detection_tasks, api_usage）
3. **缓存层**：Redis缓存检测结果、模板配置
4. **异步处理**：检测任务使用消息队列（Celery）

---

这个设计完整吗？需要我为您生成数据库创建脚本或详细的API接口设计文档吗？


