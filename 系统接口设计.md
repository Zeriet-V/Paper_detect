# 论文格式检测系统 - 接口设计文档

## 接口列表

| 接口名称 | 接口地址 | 请求方式 | 请求参数 | 返回信息 | 接口描述 |
|---------|---------|---------|---------|---------|---------|
| 用户登录 | /login | POST | 用户名、密码 | 登录状态、用户信息、会话令牌 | 用于验证用户信息并创建登录会话的接口 |
| 用户注册 | /register | POST | 用户名、密码、邮箱 | 注册状态、用户ID | 用于注册新用户账号的接口 |
| 用户登出 | /logout | POST | 会话令牌 | 登出状态 | 用于注销用户会话的接口 |
| 稿件上传 | /manuscript/upload | POST | 文件、用户ID | 上传状态、稿件ID | 用于上传论文稿件到系统的接口 |
| 稿件列表 | /manuscript/list | POST | 用户ID、状态筛选 | 稿件列表 | 用于获取用户所有稿件列表的接口 |
| 稿件下载 | /manuscript/download | POST | 稿件ID、用户ID | 文件下载地址 | 用于下载原始稿件文件的接口 |
| 稿件删除 | /manuscript/delete | POST | 稿件ID、用户ID | 删除状态 | 用于删除指定稿件及其关联数据的接口 |
| 启动检测 | /detection/start | POST | 稿件ID、是否启用图片API | 任务ID、任务状态 | 用于创建并启动格式检测任务的接口 |
| 检测状态 | /detection/status | POST | 任务ID | 任务状态、进度百分比 | 用于查询检测任务执行状态的接口 |
| 检测结果 | /detection/result | POST | 任务ID | 检测结果JSON | 用于获取检测任务完整结果的接口 |
| 图片列表 | /figure/list | POST | 任务ID、稿件ID | 图片列表 | 用于获取稿件提取的所有图片列表的接口 |
| 图片下载 | /figure/download | POST | 图片ID | 图片文件下载地址 | 用于下载提取的图片文件的接口 |
| 图片内容检测结果 | /figure/content | POST | 图片ID | 图表类型、5项检测结果 | 用于获取图片AI内容检测详情的接口 |
| 生成文本报告 | /report/generate/text | POST | 任务ID | 报告路径、生成状态 | 用于生成文本格式检测报告的接口 |
| 生成批注报告 | /report/generate/annotated | POST | 任务ID | 报告路径、生成状态 | 用于生成带批注Word文档的接口 |
| 报告下载 | /report/download | POST | 报告ID、报告类型 | 文件下载地址 | 用于下载检测报告文件的接口 |
| 模板列表 | /template/list | POST | 模板类型 | 模板列表 | 用于获取检测模板列表的接口 |
| 模板上传 | /template/upload | POST | 模板文件、模板名称、模板类型 | 上传状态、模板ID | 用于上传新检测模板的接口（管理员） |
| 模板修改 | /template/update | POST | 模板ID、配置JSON | 修改状态 | 用于修改模板配置的接口（管理员） |
| 模板删除 | /template/delete | POST | 模板ID | 删除状态 | 用于删除检测模板的接口（管理员） |
| API统计 | /api/statistics | POST | 任务ID、时间范围 | Token消耗、费用统计 | 用于查询API调用统计和费用的接口 |

---

## 接口详细设计

### 1. 用户管理接口

#### 1.1 用户登录

**接口名称**：用户登录  
**接口地址**：`/login`  
**请求方式**：POST  
**接口描述**：用于验证用户信息并创建登录会话的接口

**请求参数**：
```json
{
  "username": "zhangsan",
  "password": "123456"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user_id": 1,
    "username": "zhangsan",
    "user_type": "author",
    "session_id": "abc123...",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_at": "2025-10-29 14:30:00"
  }
}
```

---

#### 1.2 用户注册

**接口名称**：用户注册  
**接口地址**：`/register`  
**请求方式**：POST  
**接口描述**：用于注册新用户账号的接口

**请求参数**：
```json
{
  "username": "lisi",
  "password": "123456",
  "email": "lisi@example.com"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": 2,
    "username": "lisi"
  }
}
```

---

#### 1.3 用户登出

**接口名称**：用户登出  
**接口地址**：`/logout`  
**请求方式**：POST  
**接口描述**：用于注销用户会话的接口

**请求参数**：
```json
{
  "session_id": "abc123...",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "登出成功"
}
```

---

### 2. 稿件管理接口

#### 2.1 稿件上传

**接口名称**：稿件上传  
**接口地址**：`/manuscript/upload`  
**请求方式**：POST (multipart/form-data)  
**接口描述**：用于上传论文稿件到系统的接口

**请求参数**：
```
file: 文件对象（.docx格式）
user_id: 用户ID
```

**返回信息**：
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "manuscript_id": 10,
    "title": "Calculating Sound Absorption...",
    "author_names": "ZHU C Y, SHAO Z Y",
    "file_name": "paper.docx",
    "file_hash": "abc123def456...",
    "upload_time": "2025-10-28 14:30:00"
  }
}
```

---

#### 2.2 稿件列表

**接口名称**：稿件列表  
**接口地址**：`/manuscript/list`  
**请求方式**：POST  
**接口描述**：用于获取用户所有稿件列表的接口

**请求参数**：
```json
{
  "user_id": 1,
  "status": "all"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 5,
    "manuscripts": [
      {
        "manuscript_id": 10,
        "title": "Calculating Sound Absorption...",
        "author_names": "ZHU C Y, SHAO Z Y",
        "upload_time": "2025-10-28 14:30:00",
        "file_name": "paper.docx"
      }
    ]
  }
}
```

---

#### 2.3 稿件下载

**接口名称**：稿件下载  
**接口地址**：`/manuscript/download`  
**请求方式**：POST  
**接口描述**：用于下载原始稿件文件的接口

**请求参数**：
```json
{
  "manuscript_id": 10,
  "user_id": 1
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "文件准备完成",
  "data": {
    "download_url": "/files/manuscript_10.docx",
    "file_name": "paper.docx",
    "file_size": 2560000
  }
}
```

---

#### 2.4 稿件删除

**接口名称**：稿件删除  
**接口地址**：`/manuscript/delete`  
**请求方式**：POST  
**接口描述**：用于删除指定稿件及其关联数据的接口

**请求参数**：
```json
{
  "manuscript_id": 10,
  "user_id": 1,
  "delete_detections": true
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": {
    "deleted_files": 1,
    "deleted_detections": 3,
    "deleted_reports": 3
  }
}
```

---

### 3. 格式检测接口

#### 3.1 启动检测

**接口名称**：启动检测  
**接口地址**：`/detection/start`  
**请求方式**：POST  
**接口描述**：用于创建并启动格式检测任务的接口

**请求参数**：
```json
{
  "manuscript_id": 10,
  "user_id": 1,
  "enable_figure_api": false
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "检测任务已创建",
  "data": {
    "task_id": "abc-123-def-456",
    "status": "pending",
    "created_at": "2025-10-28 14:30:00"
  }
}
```

---

#### 3.2 检测状态

**接口名称**：检测状态  
**接口地址**：`/detection/status`  
**请求方式**：POST  
**接口描述**：用于查询检测任务执行状态的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "task_id": "abc-123-def-456",
    "status": "processing",
    "progress": 65.5,
    "current_module": "Figure",
    "started_at": "2025-10-28 14:30:05",
    "estimated_remaining": 120
  }
}
```

---

#### 3.3 检测结果

**接口名称**：检测结果  
**接口地址**：`/detection/result`  
**请求方式**：POST  
**接口描述**：用于获取检测任务完整结果的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "task_id": "abc-123-def-456",
    "status": "completed",
    "overall_pass_rate": 72.0,
    "total_issues": 18,
    "modules": {
      "Title": {"status": "fail", "passed": 3, "failed": 1},
      "Abstract": {"status": "fail", "passed": 2, "failed": 1},
      "Figure": {"status": "fail", "passed": 0, "failed": 2}
    },
    "completed_at": "2025-10-28 14:32:15"
  }
}
```

---

### 4. 图片管理接口

#### 4.1 图片列表

**接口名称**：图片列表  
**接口地址**：`/figure/list`  
**请求方式**：POST  
**接口描述**：用于获取稿件提取的所有图片列表的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456",
  "manuscript_id": 10
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 2,
    "figures": [
      {
        "figure_id": 50,
        "figure_index": 1,
        "figure_number": 5,
        "has_caption": true,
        "caption_text": "Fig. 5 Comparison of...",
        "image_path": "/figures/test_Fig5.png",
        "chart_type": "折线图"
      },
      {
        "figure_id": 51,
        "figure_index": 2,
        "figure_number": null,
        "has_caption": false,
        "caption_text": null,
        "image_path": "/figures/test_Fig2.png",
        "chart_type": "照片"
      }
    ]
  }
}
```

---

#### 4.2 图片下载

**接口名称**：图片下载  
**接口地址**：`/figure/download`  
**请求方式**：POST  
**接口描述**：用于下载提取的图片文件的接口

**请求参数**：
```json
{
  "figure_id": 50
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "文件准备完成",
  "data": {
    "download_url": "/files/test_Fig5.png",
    "file_name": "test_Fig5.png",
    "file_size": 256000
  }
}
```

---

#### 4.3 图片内容检测结果

**接口名称**：图片内容检测结果  
**接口地址**：`/figure/content`  
**请求方式**：POST  
**接口描述**：用于获取图片AI内容检测详情的接口

**请求参数**：
```json
{
  "figure_id": 50
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "figure_id": 50,
    "is_chart": true,
    "chart_type": "折线图",
    "checks": {
      "tick_direction": {"ok": false, "description": "刻度线指向图外"},
      "unit_format": {"ok": true, "issues": []},
      "unit_brackets": {"ok": false, "issues": ["V/m应为(V/m)"]},
      "decimal_consistency": {"ok": true, "description": "小数位一致"},
      "axis_title_consistency": {"ok": true, "description": "都用符号"}
    }
  }
}
```

---

### 5. 报告管理接口

#### 5.1 生成文本报告

**接口名称**：生成文本报告  
**接口地址**：`/report/generate/text`  
**请求方式**：POST  
**接口描述**：用于生成文本格式检测报告的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "报告生成成功",
  "data": {
    "report_id": 80,
    "report_type": "text",
    "report_path": "/reports/test_report.txt",
    "file_size": 5120,
    "generated_at": "2025-10-28 14:33:00"
  }
}
```

---

#### 5.2 生成批注报告

**接口名称**：生成批注报告  
**接口地址**：`/report/generate/annotated`  
**请求方式**：POST  
**接口描述**：用于生成带批注Word文档的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "批注报告生成成功",
  "data": {
    "report_id": 80,
    "report_type": "annotated",
    "report_path": "/reports/test_annotated.docx",
    "file_size": 2800000,
    "total_comments": 18,
    "generated_at": "2025-10-28 14:33:15"
  }
}
```

---

#### 5.3 报告下载

**接口名称**：报告下载  
**接口地址**：`/report/download`  
**请求方式**：POST  
**接口描述**：用于下载检测报告文件的接口

**请求参数**：
```json
{
  "report_id": 80,
  "report_type": "text"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "文件准备完成",
  "data": {
    "download_url": "/files/test_report.txt",
    "file_name": "test_report.txt",
    "file_size": 5120
  }
}
```

---

### 6. 模板管理接口

#### 6.1 模板列表

**接口名称**：模板列表  
**接口地址**：`/template/list`  
**请求方式**：POST  
**接口描述**：用于获取检测模板列表的接口

**请求参数**：
```json
{
  "template_type": "Figure"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 3,
    "templates": [
      {
        "template_id": 1,
        "template_name": "标准图片检测规则",
        "template_type": "Figure",
        "is_default": true,
        "is_active": true,
        "created_at": "2025-10-01 10:00:00"
      },
      {
        "template_id": 2,
        "template_name": "严格图片检测规则",
        "template_type": "Figure",
        "is_default": false,
        "is_active": true,
        "created_at": "2025-10-15 11:00:00"
      }
    ]
  }
}
```

---

#### 6.2 模板上传

**接口名称**：模板上传  
**接口地址**：`/template/upload`  
**请求方式**：POST  
**接口描述**：用于上传新检测模板的接口（仅管理员）

**请求参数**：
```json
{
  "template_name": "自定义Figure模板",
  "template_type": "Figure",
  "config_json": {
    "format_rules": {...},
    "check_rules": {...},
    "messages": {...}
  },
  "user_id": 1
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "模板上传成功",
  "data": {
    "template_id": 3,
    "template_name": "自定义Figure模板",
    "created_at": "2025-10-28 15:00:00"
  }
}
```

---

#### 6.3 模板修改

**接口名称**：模板修改  
**接口地址**：`/template/update`  
**请求方式**：POST  
**接口描述**：用于修改模板配置的接口（仅管理员）

**请求参数**：
```json
{
  "template_id": 3,
  "config_json": {
    "format_rules": {...},
    "check_rules": {...}
  },
  "user_id": 1
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "模板修改成功",
  "data": {
    "template_id": 3,
    "old_version": 1,
    "new_version": 2,
    "updated_at": "2025-10-28 15:10:00"
  }
}
```

---

#### 6.4 模板删除

**接口名称**：模板删除  
**接口地址**：`/template/delete`  
**请求方式**：POST  
**接口描述**：用于删除检测模板的接口（仅管理员）

**请求参数**：
```json
{
  "template_id": 3,
  "user_id": 1
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "模板删除成功"
}
```

---

### 7. 统计分析接口

#### 7.1 API统计

**接口名称**：API统计  
**接口地址**：`/api/statistics`  
**请求方式**：POST  
**接口描述**：用于查询API调用统计和费用的接口

**请求参数**：
```json
{
  "task_id": "abc-123-def-456",
  "start_time": "2025-10-01 00:00:00",
  "end_time": "2025-10-31 23:59:59"
}
```

**返回信息**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total_calls": 12,
    "successful_calls": 11,
    "failed_calls": 1,
    "total_tokens": 1200,
    "total_cost": 0.15,
    "average_duration": 850,
    "by_check_type": {
      "is_chart": 2,
      "tick_direction": 2,
      "unit_format": 2,
      "unit_brackets": 2,
      "decimal_consistency": 2,
      "axis_title_consistency": 2
    }
  }
}
```

---

## 📊 接口分类汇总

### 按功能模块分类

| 模块 | 接口数量 | 接口列表 |
|------|---------|---------|
| **用户管理** | 3 | 登录、注册、登出 |
| **稿件管理** | 4 | 上传、列表、下载、删除 |
| **格式检测** | 3 | 启动检测、查询状态、获取结果 |
| **图片管理** | 3 | 图片列表、图片下载、内容检测结果 |
| **报告管理** | 3 | 生成文本报告、生成批注报告、报告下载 |
| **模板管理** | 4 | 模板列表、上传、修改、删除 |
| **统计分析** | 1 | API统计 |
| **总计** | 21 | 21个接口 |

---

## 🔐 接口权限说明

### 权限级别

| 权限级别 | 角色 | 可访问接口 |
|---------|------|-----------|
| **公开** | 所有人 | 登录、注册 |
| **已登录** | author、admin | 登出、稿件上传/列表/下载、启动检测、查询状态、获取结果、图片相关、报告相关 |
| **管理员** | admin | 模板上传/修改/删除、API统计、所有用户的稿件查看 |

### 接口鉴权

所有需要登录的接口都需要在请求头中携带token：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 📋 通用返回格式

### 成功响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}
```

### 错误响应

```json
{
  "code": 400/401/403/404/500,
  "message": "错误描述",
  "error": "详细错误信息"
}
```

### 状态码说明

| 状态码 | 说明 |
|-------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或会话过期 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 🚀 接口使用流程示例

### 完整检测流程

```
1. 用户登录
   POST /login
   ↓
2. 上传稿件
   POST /manuscript/upload
   ↓ (获得manuscript_id)
3. 启动检测
   POST /detection/start
   ↓ (获得task_id)
4. 轮询查询状态
   POST /detection/status (每3秒查询一次)
   ↓ (status变为completed)
5. 获取检测结果
   POST /detection/result
   ↓
6. 生成批注报告
   POST /report/generate/annotated
   ↓ (获得report_id)
7. 下载报告
   POST /report/download
```

---

这个接口设计是否符合您的要求？需要调整或补充哪些接口吗？
