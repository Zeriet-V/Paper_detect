# 批注功能改进说明

## 改进内容

### 问题描述
之前的批注定位策略会将所有正文格式问题的批注都添加到 "Introduction" 标题段落上，导致批注不够精确。

### 改进方案
现在系统能够识别错误消息中的段落编号（如"正文段落 1"、"正文段落 2"），并将批注精确地添加到对应的具体正文段落上。

### 改进细节

#### 1. 新增功能函数

**`extract_paragraph_number_from_message(message)`**
- 从错误消息中提取段落编号
- 例如："正文段落 1 字体大小..." → 返回 1

**`group_messages_by_paragraph(messages)`**
- 将消息按段落编号分组
- 返回 {段落编号: [消息列表]} 的字典

**`find_content_paragraph_by_number(doc, para_number, hierarchy_report)`**
- 根据段落编号定位具体的正文段落
- 从Introduction之后开始计数
- 跳过标题段落，只计数正文段落

#### 2. 定位策略改进

**Content模块的特殊处理**：
- 对于 `content_format` 检测项，按段落编号分组
- 为每个段落创建独立的批注issue
- 使用 `content_paragraph` 定位方法精确定位

**定位流程**：
1. 解析错误消息，提取段落编号
2. 找到 Introduction 段落的索引
3. 从 Introduction 之后开始遍历
4. 跳过标题段落，计数正文段落
5. 定位到第N个正文段落
6. 在该段落上添加批注

### 测试结果

**测试文件**: `template/test.docx`

**检测结果**:
- 识别问题: 8个
- 成功添加批注: 7个
- 失败: 1个（脚注问题，文档中无脚注分隔线）

**批注详情**:
```
✓ Title-affiliations → 单位段落
✓ Title-format → 标题段落
✓ Abstract-format → Abstract段落
✓ Content-content_format → Introduction标题（总体提示）
✓ Content-content_format_para1 → 第1个正文段落
✓ Content-content_format_para2 → 第2个正文段落
✓ Formula-formula_detection → 公式段落
```

### 改进效果对比

#### 改进前
```
所有Content问题 → Introduction标题
```
- 问题：批注不精确，用户需要自己找问题段落

#### 改进后
```
正文段落1的问题 → 第1个正文段落
正文段落2的问题 → 第2个正文段落
```
- 优点：批注精确定位，用户直接看到具体段落的问题

### 使用示例

```bash
python run_all_detections.py template/test.docx
```

**输出**:
1. `template/test_report.txt` - 综合检测报告
2. `template/test_annotated.docx` - 带批注的文档（批注精确标注在问题段落上）

### 支持的模块

当前精确段落定位支持：
- ✅ **Content模块** - 正文格式检测（已实现段落级批注）
- ⚠️ **其他模块** - 使用关键字或索引定位（段落级或节级批注）

### 未来扩展

可以为其他模块实现类似的段落级精确定位：
- Title模块：为每个标题、作者、单位段落独立批注
- Formula模块：为每个公式段落独立批注
- 等等

## 技术亮点

1. **智能消息解析** - 从错误消息中自动提取段落编号
2. **精确段落计数** - 正确跳过标题段落，只计数正文段落
3. **灵活定位策略** - 结合标题信息和段落遍历，准确定位目标段落
4. **向后兼容** - 不影响其他模块的批注功能

## 总结

此次改进显著提升了批注的精确性，使用户能够直接在出现问题的具体段落上看到详细的错误信息，大大提高了检测系统的实用性和用户体验。


